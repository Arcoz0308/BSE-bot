// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String        @id
  userXP      GuildMember[]
  bumps       Bump[]
  username    String
  avatar      String?
  displayName String

  @@map("users")
}

model GuildMember {
  displayName String?
  avatar      String?
  userId      String
  guildId     String
  guild       Guild   @relation(fields: [guildId], references: [id])
  user        User    @relation(fields: [userId], references: [id])
  xp          Int

  @@id([guildId, userId])
  @@map("guildMembers")
}

model Guild {
  id                   String        @id
  name                 String        @default("null")
  guildMembers         GuildMember[]
  xpMovements          XpMovement[]
  bumps                Bump[]
  lastPubMessage       DateTime?
  messagesSinceLastPub Int           @default(0)

  @@map("guilds")
}

model Bump {
  userId  String
  guildId String
  guild   Guild    @relation(fields: [guildId], references: [id])
  user    User     @relation(fields: [userId], references: [id])
  date    DateTime @default(now())

  @@id([guildId, userId, date])
  @@map("bumps")
}

model XpMovement {
  id        Int             @id @default(autoincrement())
  xpAmount  Int
  finalXp   Int
  byUserId  String
  forUserId String
  date      DateTime        @default(now())
  cause     XpMovementCause
  guildId   String
  guild     Guild           @relation(fields: [guildId], references: [id])
  reason    String

  @@map("xpMovements")
}

enum XpMovementCause {
  XPDROP
  ADMINXP
  XPIMPORT
  PRIME
  REVERSE
  OTHER
}
